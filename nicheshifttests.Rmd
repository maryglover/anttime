---
title: "Testing for species niche shifts"
author: "Quentin D. Read"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, tidy = FALSE)
```

## Summary

Here, I calculated the pairwise distance between the foraging time distributions for all chambers, *within* species at each site. We can test individual pairs of chambers to see if the temporal niche distributions of the chambers are significantly different from each other, but that does not really address the hypothesis. What I did here is run a Mantel test, which is a statistical test to see whether two distance matrices are correlated. The question it answers here is: for each individual ant species, if two chambers are more similar in temperature, is the temporal niche distribution of the ants in those chambers more similar? I used two different measures of distance, one is 1 minus the overlap, the other is the "earth mover's distance" which is another way of looking at the distance between two distributions. In both cases I used circular statistics, and did a separate test for each species. 

I also used the circular mean to see whether the mean time of activity (not caring at all about the shape of the distribution) changes with temperature. I calculated the mean for all the species and chambers and did a single mixed model with all the species.

For the distance tests, basically the answer is no trend. The only one that might be changing with temperature is *Aphaenogaster rudis* at Duke Forest. It has $p < 0.1$ for both distance metrics. It appears to be changing from midday to evening activity as temperature increases. However it's not too surprising to get one marginally significant trend from chance alone if you look at enough species. 

For the mean tests, it looks a little like *Aphaenogaster* is getting later and *Prenolepis* is getting earlier at Duke Forest. That is a fairly weak trend that is not really statistically supported. So overall I think the hypothesis of little change is supported though there are some potential things happening.

The raw R code used to generate this document is not in the PDF but it is in the GitHub repository at `github.com/qdread/anttime/nicheshifttests.Rmd`. You can reproduce this analysis by running that code. Note that the `Ostats` package needs to be installed using `devtools::install_github('NEON-biodiversity/Ostats')`.

The histograms for all the different species are not in this document, they are in another document (`time_plots_allspp.pdf`).

```{r load and wrangle data, message = FALSE}
library(tidyverse)
library(ade4)
library(Ostats)
library(emdist)
library(circular)
library(brms)
library(brmstools)

theme_set(theme_minimal())

trt <- read_csv('data/chamber_treatments.csv')
dat <- read_csv('data/data_allmonths_allsites.csv')

# Create a new column in treatment with the temp and chamber ID
# Order it by the temperature so the plots are in ascending temp order
trt <- trt %>%
  mutate(chamber_temp = paste0('chamber ', chamber, ': +', temperature, 'C')) %>%
  mutate(chamber_temp = factor(chamber_temp, 
                               levels = unique(chamber_temp)[order(site, temperature)]))

# Convert month to ordered factor and join with treatment
dat <- dat %>%
  filter(!spp %in% c('none','unk'), !is.na(spp)) %>%
  mutate(month = factor(month, levels = month.name)) %>%
  left_join(trt)

# Additional data wrangling:
# Convert to long form with one row per individual ant observed.
dat_long <- dat %>%
  group_by(site, month, date, time,  chamber, temperature, chamber_temp) %>%
  group_modify(~ data.frame(sp = rep(.$spp, each = .$number)))

# Filter the data to show only species with at least 100 individuals
# Also define seasons
dat_common <- dat_long %>%
  filter(!is.na(temperature)) %>%
  mutate(season = if_else(month %in% month.name[4:9], 'summer', 'winter')) %>%
  group_by(sp) %>%
  filter(n() >= 100)

# Set color palette for all species
sp_descend <- dat_common %>% summarize(n=n()) %>% arrange(-n) %>% pull(sp)
fill_palette <- scale_fill_manual(values = 
  setNames(c(RColorBrewer::brewer.pal(9, 'Set1'), 'turquoise'), sp_descend))
color_palette <- scale_color_manual(values = 
  setNames(c(RColorBrewer::brewer.pal(9, 'Set1'), 'turquoise'), sp_descend))

```


## Overlap within species

Here I calculate all the pairwise distances between the time distributions for all pairs of chambers for each species. Because there are 12 chambers there are 66 possible pairs at each site. I use two different ways of calculating the distance. The first is 1 - the pairwise overlap of the distributions. The second is the earth mover's distance (EMD). EMD represents the amount of work it would take to convert one distribution to another, if you imagine them as two piles of dirt with different heights and in slightly different places.

I got the code for doing the distances over circular distributions from [Kjetil Halvorsen on StackOverflow.com](https://stats.stackexchange.com/questions/461345/earth-movers-distance-implementation-for-circular-distributions). The densities are just the histograms for each species-chamber combination with 24 bins, one for each hour.

I calculated all pairwise distances for all combinations of species and site. Only use species with >100 individuals and chambers with >5 individuals for that species and where there were at least two different times when ants were seen.

```{r define functions}
# Distance between two hour distributions
hourdist <- function(A, B) sum(pmin(  (A-B)%%24, (B-A)%%24 ) )  

# Manually calculate density from the vector of hours
calc_weight <- function(x) { # a vector of hours
    tab <- table(factor(x,  levels=as.character(0:23)),
                 useNA="ifany")

    dimnames(tab) <- NULL
    weights <- tab / sum(tab)

    mat <- cbind( weights=weights, points=0:23 )
    mat
  }

# Calculate EMD or overlap distance for all pairs (function)
all_pairs_asmatrix <- function(traits, sp, metric = c('overlap', 'emd')) {
  require(emdist)
  dat <- data.frame(traits=traits, sp=sp, stringsAsFactors = FALSE)
  dat <- dat[complete.cases(dat), ]
  abunds <- table(dat$sp)
  abunds <- abunds[abunds>1]
  spp <- names(abunds)
  dat <- dat[dat$sp %in% spp, ]
  traitlist <- split(dat$traits, dat$sp)
  nspp <- length(traitlist)
  
  distances <- matrix(NA, nrow = nspp, ncol = nspp)
  
  for (sp_a in 1:(nspp-1)) {
    for (sp_b in (sp_a+1):nspp) {
      a <- traitlist[[sp_a]]
      b <- traitlist[[sp_b]]
      density_a <- calc_weight(a)
      density_b <- calc_weight(b)
      if (metric[1] == 'emd') {
        distances[sp_a, sp_b] <- emd(density_a, density_b, dist = hourdist)       
      } 
      if (metric[1] == 'overlap') {
        distances[sp_a, sp_b] <- 
          1 - circular_overlap_24hour(a, b)[1]
      }
    }
  }
  
  dimnames(distances) <- list(spp, spp)
  distances
}

```

```{r calculate distances}
# Create temperature distance matrix
duke_temp_dist <- dist(trt$temperature[trt$site == 'Duke'])
harvard_temp_dist <- dist(trt$temperature[trt$site == 'Harvard'])

overlap_mats <- dat_common %>%
  group_by(site, sp, chamber) %>%
  filter(n() >= 5 & length(unique(time)) > 1) %>%
  ungroup %>%
  group_by(site, sp) %>%
  filter(length(unique(chamber)) > 1) %>%
  nest %>%
  mutate(temp_dist = if_else(site == 'Duke', 
                             list(duke_temp_dist), 
                             list(harvard_temp_dist))) %>%
  mutate(mat = map(data, 
                   ~ all_pairs_asmatrix(traits = .$time, 
                                        sp = .$chamber, 
                                        metric = 'overlap')),
         mat_emd = map(data, 
                       ~ all_pairs_asmatrix(traits = .$time, 
                                            sp = .$chamber, 
                                            metric = 'emd')),
         temp_dist = map2(mat, temp_dist, 
                          ~ as.dist(as.matrix(.y)[as.numeric(row.names(.x)), 
                                                  as.numeric(row.names(.x))])),
         dist_overlap = map(mat, ~ as.dist(t(.))),
         dist_emd = map(mat_emd, ~ as.dist(t(.))))
```

Here are a few "heat map" plots that attempt to show the (lack of) relationship. If a species' distance matrix is correlated with the temperature distance matrix, it will look more similar. For the temperature heatmap, pairs of chambers with very far apart temperatures are shown in brighter color (yellow) and are at the upper right. If a species would respond in a predictable way to temperature, we would also see more yellow in the corner and more purple on the diagonal. I don't really see it!

I only plot a couple of the species for the sake of space.

```{r define heatmap functions}
# Key to sort matrices by increasing temp.
duke_key <- with(trt[trt$site == 'Duke', ], chamber[order(temperature)])
harvard_key <- with(trt[trt$site == 'Harvard', ], chamber[order(temperature)])

heat_map <- function(mat, key, title) {
  if (class(mat) == 'matrix') mat <- pmin(mat,t(mat), na.rm = TRUE) else mat <- as.matrix(mat)
  mat_sorted <- mat[key, key]
  mat_sorted[lower.tri(mat_sorted, diag = TRUE)] <- NA
  
  rotate <- function(x) t(apply(x, 2, rev))
  
  image(rotate(mat_sorted), xaxt = 'none', yaxt = 'none', bty = 'n', col = hcl.colors(12, palette = 'viridis', rev = FALSE), main = title)
  axis(3, at = seq(0,1,length.out=12)[-1], labels = key[-1], tick = FALSE)
  axis(4, at = seq(1,0,length.out=12)[-12], labels = key[-12], tick = FALSE, las = 1)
}
```


### *Aphaenogaster rudis* (Duke)

```{r apru heatmap}
par(mfcol = c(1,3), pty = 's', mar = c(5.1, 4.1, 6, 2.1))

heat_map(duke_temp_dist/max(duke_temp_dist), duke_key, 'temperature treatments')
heat_map(overlap_mats$mat_emd[[6]]/max(overlap_mats$mat_emd[[6]], na.rm = TRUE), duke_key, 'earth mover\'s distance')
heat_map(overlap_mats$mat[[6]]/max(overlap_mats$mat[[6]], na.rm = TRUE), duke_key, '1 - overlap')

```

### *Prenolepis imparis* (Duke)

```{r prim heatmap}
par(mfcol = c(1,3), pty = 's', mar = c(5.1, 4.1, 6, 2.1))

heat_map(duke_temp_dist/max(duke_temp_dist), duke_key, 'temperature treatments')
heat_map(overlap_mats$mat_emd[[1]]/max(overlap_mats$mat_emd[[1]], na.rm = TRUE), duke_key, 'earth mover\'s distance')
heat_map(overlap_mats$mat[[1]]/max(overlap_mats$mat[[1]], na.rm = TRUE), duke_key, '1 - overlap')

```

### *Crematogaster lineolata* (Duke)

```{r crli heatmap}
par(mfcol = c(1,3), pty = 's', mar = c(5.1, 4.1, 6, 2.1))

heat_map(duke_temp_dist/max(duke_temp_dist), duke_key, 'temperature treatments')
heat_map(overlap_mats$mat_emd[[3]]/max(overlap_mats$mat_emd[[3]], na.rm = TRUE), duke_key, 'earth mover\'s distance')
heat_map(overlap_mats$mat[[3]]/max(overlap_mats$mat[[3]], na.rm = TRUE), duke_key, '1 - overlap')

```

## Mantel tests

The Mantel test is a statistical test to see if two distance matrices are correlated. We do one for each species, where one matrix is the temperature treatment difference between the pairs of chambers and the other is the distance between the foraging time distributions between the pairs of chambers. The alternative hypothesis is that as the difference between the temperatures of two chambers gets greater, the distance between the foraging time distributions will also get greater.

```{r mantel tests}
set.seed(919)

# Mantel tests for the two distance metrics for all species/site combos.
overlap_mats <- overlap_mats %>%
  mutate(mantel_test_overlap = 
           map2(temp_dist, dist_overlap, ~ mantel.rtest(.x, .y, nrepet = 9999)),
         mantel_test_emd = 
           map2(temp_dist, dist_emd, ~ mantel.rtest(.x, .y, nrepet = 9999))
  )

# Extract p values (OMG p values)
overlap_mats <- overlap_mats %>%
  mutate_at(vars(starts_with('mantel_test')), 
            list(stat = ~ map_dbl(., 'obs'), 
                 p_val = ~ map_dbl(., 'pvalue')))
```

If we just look at the p-values, we can see that there is only the slight suggestion of a trend for *Aphaenogaster rudis* at Duke Forest. The two metrics seem to agree pretty well which is good. (*Temnothorax curvispinosus* shows marginal significance for one metric as well but it has fairly few individuals so might be more like noise).

```{r show p-values, echo = FALSE}
overlap_mats %>%
  select(site, sp, contains('p_val'))
```


## Change in mean foraging time

To make things a little simpler, I also calculated the "circular mean" of the activity times for each species in each chamber. Then I did a mixed model for each site to see if temperature predicts mean activity time, with species as a random effect (random intercept and random slope).

```{r model mean foraging time}
mean_times <- dat_common %>%
  group_by(site, sp, chamber, temperature, chamber_temp) %>%
  summarize(mean_time = mean(circular(time, units = 'hours', modulo = '2pi')))

options(mc.cores = 2)
duke_mean_bayesfit <- brm(mean_time ~ temperature + (temperature | sp), 
                          data = mean_times %>% filter(site == 'Duke'),
                          chains = 2, iter = 2000, warmup = 1000)
harvard_mean_bayesfit <- brm(mean_time ~ temperature + (temperature | sp), 
                             data = mean_times %>% filter(site == 'Harvard'),
                          chains = 2, iter = 2000, warmup = 1000)
```

These plots show the trends for each species from the mixed model.

```{r panel plots}
hour_y <- scale_y_continuous(name = 'time')
cutoff_y <- coord_cartesian(ylim = c(0, 23))
panels(duke_mean_bayesfit, grouping = 'sp', xvar = 'temperature') + 
  ggtitle('Duke Forest') + hour_y + cutoff_y
panels(harvard_mean_bayesfit, grouping = 'sp', xvar = 'temperature') + 
  ggtitle('Harvard Forest') + hour_y + cutoff_y

```


These are the coefficients for each species at Duke Forest and at Harvard Forest. The R-squared for the Duke model is `r round(bayes_R2(duke_mean_bayesfit)[1,1], 3)` and for the Harvard model it is `r round(bayes_R2(harvard_mean_bayesfit)[1,1], 3)`.

```{r show model result}
coef(duke_mean_bayesfit)$sp[,,'temperature']
coef(harvard_mean_bayesfit)$sp[,,'temperature']
```

The thing to look at is not really the overall effect of temperature &mdash; the slopes for each individual species are what matter. The 95% credible interval of the slopes for all of the individual species overlaps zero, meaning that no species has a trend in its mean activity time with temperature. The two species that are closest to having a trend (both at Duke) are *A. rudis* which looks like it is moving from early to late, and *P. imparis* which looks like it is moving from late to early (more or less like we saw in the histograms, where the late afternoon activity is reduced). However they aren't strong trends. 

I'm not really sure whether it means too much to look at the mean time, since species could have multiple peaks of activity time per day. It's just something I tried out.

## Repeat with summer only for Duke

To check whether it's okay to lump together summer and winter for Duke Forest, I ran the exact same tests with summer only. (The non-summer data was too sparse to do it separately for winter.) The p-values are shown below.

```{r analysis for summer only, echo = FALSE}
overlap_mats_summer <- dat_common %>%
  filter(site == 'Duke', season == 'summer') %>%
  group_by(site, sp, chamber) %>%
  filter(n() >= 5 & length(unique(time)) > 1) %>%
  ungroup %>%
  group_by(site, sp) %>%
  filter(length(unique(chamber)) > 1) %>%
  nest %>%
  mutate(temp_dist = if_else(site == 'Duke', 
                             list(duke_temp_dist), 
                             list(harvard_temp_dist))) %>%
  mutate(mat = map(data, 
                   ~ all_pairs_asmatrix(traits = .$time, 
                                        sp = .$chamber, 
                                        metric = 'overlap')),
         mat_emd = map(data, 
                       ~ all_pairs_asmatrix(traits = .$time, 
                                            sp = .$chamber, 
                                            metric = 'emd')),
         temp_dist = map2(mat, temp_dist, 
                          ~ as.dist(as.matrix(.y)[as.numeric(row.names(.x)), 
                                                  as.numeric(row.names(.x))])),
         dist_overlap = map(mat, ~ as.dist(t(.))),
         dist_emd = map(mat_emd, ~ as.dist(t(.))))

set.seed(410)

# Mantel tests for the two distance metrics for all species/site combos.
overlap_mats_summer <- overlap_mats_summer %>%
  mutate(mantel_test_overlap = 
           map2(temp_dist, dist_overlap, ~ mantel.rtest(.x, .y, nrepet = 9999)),
         mantel_test_emd = 
           map2(temp_dist, dist_emd, ~ mantel.rtest(.x, .y, nrepet = 9999))
  )

# Extract p values (OMG p values)
overlap_mats_summer <- overlap_mats_summer %>%
  mutate_at(vars(starts_with('mantel_test')), 
            list(stat = ~ map_dbl(., 'obs'), 
                 p_val = ~ map_dbl(., 'pvalue')))

overlap_mats_summer %>%
  select(site, sp, contains('p_val'))
```

We now see a more suggestive trend with *Crematogaster* but less of a trend for the other species. If you look at the histograms for *Crematogaster* it does sort of look like it is less active during the middle of the day in the hotter chambers.

Let's look at the mixed model for mean times for summer only too.

```{r model mean time summer only, echo = FALSE}
mean_times_summer <- dat_common %>%
  group_by(site, sp, season, chamber, temperature, chamber_temp) %>%
  summarize(mean_time = mean(circular(time, units = 'hours', modulo = '2pi')))

dukesummer_mean_bayesfit <- brm(mean_time ~ temperature + (temperature | sp), data = mean_times_summer %>% filter(site == 'Duke', season == 'summer'),
                          chains = 2, iter = 2000, warmup = 1000)

coef(dukesummer_mean_bayesfit)$sp[,,'temperature']
```

No overall trends with the means ... all overlap zero and it isn't close.